<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent IA de prospection - API Gouv & OSINT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 1);
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2 italic">Prospecteur Certifié</h1>
            <p class="text-slate-500 font-medium">Données Officielles (Base SIRENE) + Enrichissement IA</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <aside class="lg:col-span-1 space-y-6">
                <div class="glass p-6 rounded-2xl shadow-sm border-t-4 border-t-indigo-500">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Paramètres de Recherche
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Code NAF</label>
                                <input type="text" id="nafInput" placeholder="ex: 42.11Z" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Dépt.</label>
                                <input type="text" id="deptInput" placeholder="ex: 54" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Taille (Effectifs)</label>
                            <div class="space-y-2 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="PME" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>PME (10-249 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="ETI" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>ETI (250-4999 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="GE" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>Grandes Entreprises (+5000)</span>
                                </label>
                            </div>
                        </div>

                        <button id="searchBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-indigo-200 transition-all flex items-center justify-center space-x-2 mt-4">
                            <span id="btnText">Lancer la recherche hybride</span>
                        </button>
                    </div>
                </div>

                <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl text-xs text-emerald-800">
                    <p class="flex items-start">
                        <svg class="w-4 h-4 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span><strong>Connexion API Gouv :</strong> Les entreprises listées proviennent directement du répertoire SIRENE mis à jour.</span>
                    </p>
                </div>
            </aside>

            <main class="lg:col-span-2">
                <div id="resultsContainer" class="glass p-6 rounded-2xl shadow-sm min-h-[500px]">
                    <div id="welcomeState" class="text-center py-20">
                        <div class="bg-indigo-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        </div>
                        <h3 class="text-lg font-medium text-slate-800">Prêt à interroger l'Insee</h3>
                        <p class="text-slate-500 max-w-xs mx-auto">Saisissez les critères pour obtenir une liste officielle certifiée.</p>
                    </div>

                    <div id="loadingState" class="hidden space-y-4 py-10">
                        <div class="flex flex-col items-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                            <p id="loadingMessage" class="text-indigo-600 font-medium italic text-center">Appel de l'API gouv.fr...</p>
                        </div>
                    </div>

                    <div id="resultsContent" class="hidden space-y-6">
                        <div class="flex justify-between items-center border-b pb-4">
                            <h2 class="text-xl font-bold text-slate-800">Résultats SIRENE Enrichis</h2>
                            <button onclick="copyTable()" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs px-4 py-2 rounded-lg font-bold">Copier pour Excel</button>
                        </div>
                        <div id="resultsList" class="space-y-4"></div>
                        <div id="groundingSources" class="mt-8 pt-6 border-t border-slate-100 text-[10px] text-slate-400"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_KEY_GEMINI = "AIzaSyBvDFQOaIGLZz0TV-7hZSBli4W3Ep_bnP8"; 
        const searchBtn = document.getElementById('searchBtn');
        const nafInput = document.getElementById('nafInput');
        const deptInput = document.getElementById('deptInput');
        const loadingState = document.getElementById('loadingState');
        const loadingMessage = document.getElementById('loadingMessage');
        const resultsContent = document.getElementById('resultsContent');
        const resultsList = document.getElementById('resultsList');
        const welcomeState = document.getElementById('welcomeState');

        // Mapping des tranches d'effectifs pour l'API Gouv
        // PME: 11, 12, 21, 22 (10 à 249)
        // ETI: 31, 32, 41 (250 à 4999)
        // GE: 51, 52, 53 (+5000)
        function getTranchesEffectifs(sizes) {
            let tranches = [];
            if (sizes.includes('PME')) tranches.push('11,12,21,22');
            if (sizes.includes('ETI')) tranches.push('31,32,41');
            if (sizes.includes('GE')) tranches.push('51,52,53');
            return tranches.join(',');
        }

        async function fetchOfficialData(naf, dept, sizes) {
            const tranches = getTranchesEffectifs(sizes);
            // Nettoyage du code NAF (supprimer point si présent)
            const cleanNaf = naf.replace('.', ''); 
            
            // Construction de l'URL API Gouv
            let url = `https://recherche-entreprises.api.gouv.fr/search?activite_principale=${cleanNaf}&departement=${dept}`;
            if (tranches) url += `&tranche_effectif_salarie=${tranches}`;
            url += `&per_page=15`;

            const response = await fetch(url);
            if (!response.ok) throw new Error("Erreur API Gouv");
            const data = await response.json();
            return data.results;
        }

        async function enrichWithGemini(entreprises) {
            if (entreprises.length === 0) return [];

            const listStr = entreprises.map(e => `${e.nom_complet} (${e.siege.adresse})`).join(', ');
            
            const prompt = `Voici une liste d'entreprises réelles issues du registre SIRENE. 
            Pour chacune, trouve par recherche web :
            1. Un numéro de téléphone de contact (si possible local).
            2. Une adresse email ou le pattern email (ex: prenom.nom@domaine.com).
            3. L'URL de leur site web officiel.
            
            Liste : ${listStr}

            Réponds UNIQUEMENT par un JSON structuré : 
            { "enrichissements": [{ "nom": "...", "tel": "...", "email": "...", "site": "..." }] }`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                generationConfig: { responseMimeType: "application/json" }
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY_GEMINI}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) return [];
            const resJson = await response.json();
            const enrichedData = JSON.parse(resJson.candidates[0].content.parts[0].text);
            return enrichedData.enrichissements || [];
        }

        searchBtn.addEventListener('click', async () => {
            const naf = nafInput.value.trim();
            const dept = deptInput.value.trim();
            const selectedSizes = Array.from(document.querySelectorAll('input[name="size"]:checked')).map(cb => cb.value);

            if (!naf || !dept) {
                alert("Veuillez remplir le NAF et le département.");
                return;
            }

            welcomeState.classList.add('hidden');
            resultsContent.classList.add('hidden');
            loadingState.classList.remove('hidden');
            loadingMessage.innerText = "Interrogation de la base SIRENE (gouv.fr)...";
            searchBtn.disabled = true;

            try {
                // ETAPE 1 : Données officielles
                const gouvResults = await fetchOfficialData(naf, dept, selectedSizes);
                
                if (gouvResults.length === 0) {
                    resultsList.innerHTML = '<p class="text-center py-10 text-slate-500">Aucune entreprise trouvée dans les registres officiels pour ces critères.</p>';
                    loadingState.classList.add('hidden');
                    resultsContent.classList.remove('hidden');
                    return;
                }

                // ETAPE 2 : Enrichissement IA
                loadingMessage.innerText = `Trouvé ${gouvResults.length} entreprises. Enrichissement OSINT par l'IA...`;
                const enriched = await enrichWithGemini(gouvResults);

                // ETAPE 3 : Affichage
                resultsList.innerHTML = '';
                gouvResults.forEach(ent => {
                    const extra = enriched.find(e => ent.nom_complet.includes(e.nom) || e.nom.includes(ent.nom_complet)) || {};
                    const card = document.createElement('div');
                    card.className = "p-5 border border-slate-200 rounded-xl bg-white shadow-sm hover:shadow-md transition-shadow";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-indigo-900 text-lg uppercase">${ent.nom_complet}</h4>
                                <p class="text-[10px] text-slate-400 font-mono">SIREN: ${ent.siren} | NAF: ${ent.activite_principale}</p>
                            </div>
                            <span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold">CERTIFIÉ SIRENE</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-4">${ent.siege.adresse}</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs border-t pt-3">
                            <div class="flex items-center">
                                <span class="font-bold mr-2 text-slate-400">TEL:</span>
                                <span class="text-slate-700">${extra.tel || 'Recherche agence nécessaire'}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold mr-2 text-slate-400">EMAIL:</span>
                                <span class="text-indigo-600 font-medium">${extra.email || 'Non listé'}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold mr-2 text-slate-400">WEB:</span>
                                ${extra.site ? `<a href="${extra.site}" target="_blank" class="text-indigo-500 underline truncate">${extra.site}</a>` : '<span class="text-slate-300 italic">Non trouvé</span>'}
                            </div>
                        </div>
                    `;
                    resultsList.appendChild(card);
                });

                loadingState.classList.add('hidden');
                resultsContent.classList.remove('hidden');
            } catch (err) {
                alert("Erreur lors de la recherche : " + err.message);
                welcomeState.classList.remove('hidden');
                loadingState.classList.add('hidden');
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerText = "Lancer la recherche hybride";
            }
        });

        function copyTable() {
            const data = Array.from(document.querySelectorAll('#resultsList > div')).map(card => {
                const nom = card.querySelector('h4').innerText.trim();
                const siren = card.querySelector('p.text-slate-400').innerText.trim();
                const adresse = card.querySelector('p.text-slate-600').innerText.trim();
                const contacts = card.querySelector('.grid').innerText.replace(/\n/g, ' | ').trim();
                return `${nom}\t${siren}\t${adresse}\t${contacts}`;
            }).join('\n');
            
            const textArea = document.createElement("textarea");
            textArea.value = "Nom\tID\tAdresse\tContacts\n" + data;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("Données copiées pour Excel !");
        }
    </script>
</body>
</html>