<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent IA de prospection - API Gouv & OSINT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 1);
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2 italic">Prospecteur Certifié</h1>
            <p class="text-slate-500 font-medium">Données Officielles (Base SIRENE) + Enrichissement IA</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <aside class="lg:col-span-1 space-y-6">
                <div class="glass p-6 rounded-2xl shadow-sm border-t-4 border-t-indigo-500">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Paramètres de Recherche
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Code NAF</label>
                                <input type="text" id="nafInput" placeholder="ex: 4211Z" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Dépt.</label>
                                <input type="text" id="deptInput" placeholder="ex: 54" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Taille (Effectifs)</label>
                            <div class="space-y-2 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="PME" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>PME (10-249 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="ETI" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>ETI (250-4999 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="GE" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>Grandes Entreprises (+5000)</span>
                                </label>
                            </div>
                        </div>

                        <button id="searchBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-indigo-200 transition-all flex items-center justify-center space-x-2 mt-4">
                            <span id="btnText">Lancer la recherche hybride</span>
                        </button>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl text-xs text-blue-800">
                    <p class="flex items-start">
                        <svg class="w-4 h-4 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        <span><strong>Note :</strong> L'API de recherche d'entreprises du gouvernement est soumise à des quotas de requêtes. Si l'erreur persiste, vérifiez la validité du code NAF.</span>
                    </p>
                </div>
            </aside>

            <main class="lg:col-span-2">
                <div id="resultsContainer" class="glass p-6 rounded-2xl shadow-sm min-h-[500px]">
                    <div id="welcomeState" class="text-center py-20">
                        <div class="bg-indigo-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        </div>
                        <h3 class="text-lg font-medium text-slate-800">Recherche SIRENE</h3>
                        <p class="text-slate-500 max-w-xs mx-auto">Interrogez la base officielle des entreprises françaises.</p>
                    </div>

                    <div id="loadingState" class="hidden space-y-4 py-10">
                        <div class="flex flex-col items-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                            <p id="loadingMessage" class="text-indigo-600 font-medium italic text-center">Connexion aux serveurs gouvernementaux...</p>
                        </div>
                    </div>

                    <div id="resultsContent" class="hidden space-y-6">
                        <div class="flex justify-between items-center border-b pb-4">
                            <h2 class="text-xl font-bold text-slate-800 italic">Résultats SIRENE</h2>
                            <button onclick="copyTable()" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs px-4 py-2 rounded-lg font-bold">Copier CSV</button>
                        </div>
                        <div id="resultsList" class="space-y-4"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_KEY_GEMINI = "AIzaSyBvDFQOaIGLZz0TV-7hZSBli4W3Ep_bnP8"; 
        const searchBtn = document.getElementById('searchBtn');
        const nafInput = document.getElementById('nafInput');
        const deptInput = document.getElementById('deptInput');
        const loadingState = document.getElementById('loadingState');
        const loadingMessage = document.getElementById('loadingMessage');
        const resultsContent = document.getElementById('resultsContent');
        const resultsList = document.getElementById('resultsList');
        const welcomeState = document.getElementById('welcomeState');

        function getTranchesEffectifs(sizes) {
            let tranches = [];
            // Mapping exact selon la nomenclature SIRENE/API Gouv
            if (sizes.includes('PME')) tranches.push("11,12,21,22");
            if (sizes.includes('ETI')) tranches.push("31,32,41");
            if (sizes.includes('GE')) tranches.push("51,52,53");
            return tranches.join(',');
        }

        async function fetchOfficialData(naf, dept, sizes) {
            // Nettoyage rigoureux du code NAF
            const cleanNaf = naf.trim().replace(/[\.\s]/g, '').toUpperCase();
            const tranches = getTranchesEffectifs(sizes);
            
            // On utilise activite_principale qui est le terme exact pour le code NAF dans l'API
            let url = `https://recherche-entreprises.api.gouv.fr/search?activite_principale=${cleanNaf}&departement=${dept}`;
            
            if (tranches) {
                // L'API attend une liste de valeurs séparées par des virgules pour ce paramètre
                url += `&tranche_effectif_salarie=${tranches}`;
            }
            
            url += `&per_page=20`;

            console.log("Appel API : ", url);

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Détails Erreur API:", errorData);
                    throw new Error(errorData.message || "Erreur de réponse serveur");
                }
                const data = await response.json();
                return data.results || [];
            } catch (e) {
                console.error("Erreur Fetch:", e);
                throw e;
            }
        }

        async function enrichWithGemini(entreprises) {
            if (entreprises.length === 0) return [];

            const listStr = entreprises.map(e => `${e.nom_complet} située à ${e.siege.adresse}`).join(' | ');
            
            const prompt = `Voici des entreprises réelles. Pour chacune, trouve par recherche web :
            1. Un téléphone.
            2. Un email.
            3. Le site web officiel.
            
            Liste : ${listStr}

            Réponds UNIQUEMENT en JSON : 
            { "enrichissements": [{ "nom": "...", "tel": "...", "email": "...", "site": "..." }] }`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY_GEMINI}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) return [];
                const resJson = await response.json();
                const text = resJson.candidates[0].content.parts[0].text;
                return JSON.parse(text).enrichissements || [];
            } catch (err) {
                console.error("Enrichissement échoué:", err);
                return [];
            }
        }

        searchBtn.addEventListener('click', async () => {
            const naf = nafInput.value.trim();
            const dept = deptInput.value.trim();
            const selectedSizes = Array.from(document.querySelectorAll('input[name="size"]:checked')).map(cb => cb.value);

            if (!naf || !dept) {
                alert("NAF (ex: 4211Z) et Département (ex: 54) obligatoires.");
                return;
            }

            welcomeState.classList.add('hidden');
            resultsContent.classList.add('hidden');
            loadingState.classList.remove('hidden');
            loadingMessage.innerText = "Interrogation de recherche-entreprises.api.gouv.fr...";
            searchBtn.disabled = true;

            try {
                const gouvResults = await fetchOfficialData(naf, dept, selectedSizes);
                
                if (gouvResults.length === 0) {
                    resultsList.innerHTML = '<div class="text-center py-10 text-slate-500">Aucun établissement trouvé. Vérifiez le code NAF ou élargissez les critères.</div>';
                } else {
                    loadingMessage.innerText = `Analyse OSINT pour ${gouvResults.length} résultats officiels...`;
                    const enriched = await enrichWithGemini(gouvResults);

                    resultsList.innerHTML = '';
                    gouvResults.forEach(ent => {
                        const extra = enriched.find(e => ent.nom_complet.includes(e.nom) || e.nom.includes(ent.nom_complet)) || {};
                        const card = document.createElement('div');
                        card.className = "p-5 border border-slate-200 rounded-xl bg-white shadow-sm";
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-indigo-900">${ent.nom_complet}</h4>
                                <span class="text-[9px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded font-bold uppercase">SIREN ${ent.siren}</span>
                            </div>
                            <p class="text-sm text-slate-500 mb-3">${ent.siege.adresse}</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs border-t pt-3">
                                <span><strong>Tel:</strong> ${extra.tel || 'Non trouvé'}</span>
                                <span class="text-indigo-600"><strong>Email:</strong> ${extra.email || 'N/A'}</span>
                                ${extra.site ? `<a href="${extra.site}" target="_blank" class="text-indigo-400 underline truncate">${extra.site}</a>` : '<span>-</span>'}
                            </div>
                        `;
                        resultsList.appendChild(card);
                    });
                }
                resultsContent.classList.remove('hidden');
            } catch (err) {
                alert("Erreur API Gouv : " + err.message + "\n\nVérifiez que le code NAF est correct (ex: 4211Z).");
                welcomeState.classList.remove('hidden');
            } finally {
                loadingState.classList.add('hidden');
                searchBtn.disabled = false;
            }
        });

        function copyTable() {
            const data = Array.from(document.querySelectorAll('#resultsList > div')).map(card => {
                const nom = card.querySelector('h4').innerText.trim();
                const adresse = card.querySelector('p').innerText.trim();
                const contacts = card.querySelector('.grid').innerText.trim().replace(/\n/g, ' ');
                return `${nom}\t${adresse}\t${contacts}`;
            }).join('\n');
            const blob = new Blob(["Nom\tAdresse\tContacts\n" + data], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'prospection.csv';
            a.click();
        }
    </script>
</body>
</html>
