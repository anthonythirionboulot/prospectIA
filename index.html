<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent OSINT B2B - Filtre CSV Intelligent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .drop-zone.active { border-color: #6366f1; background: #f8fafc; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2 italic">Agent IA Prospecteur</h1>
            <p class="text-slate-500 font-medium">Spécialiste Exports Annuaire des Entreprises (SIRENE)</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <aside class="lg:col-span-1 space-y-6">
                <div class="glass p-6 rounded-2xl shadow-sm border-t-4 border-t-indigo-500">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h13m-13 4h13m-13 4h13"></path></svg>
                        1. Charger le CSV
                    </h2>
                    <div id="dropZone" class="drop-zone p-6 rounded-xl text-center cursor-pointer mb-4">
                        <input type="file" id="fileInput" accept=".csv" class="hidden">
                        <p class="text-xs text-slate-500">Déposez votre export SIRENE</p>
                    </div>
                    <div id="fileStatus" class="hidden p-3 bg-emerald-50 text-emerald-700 text-xs rounded-lg mb-4">
                        Fichier reconnu : <span id="fileCount" class="font-bold">0</span> lignes.
                    </div>

                    <h2 class="text-lg font-bold mb-4 flex items-center pt-4 border-t">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        2. Filtres Précis
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Département (ex: 54)</label>
                            <input type="text" id="deptFilter" placeholder="54" class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Taille d'entreprise</label>
                            <div class="space-y-2 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <label class="flex items-center space-x-3 text-xs cursor-pointer">
                                    <input type="checkbox" name="size" value="PME" class="w-4 h-4 text-indigo-600 rounded" checked>
                                    <span>PME (10-249 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-xs cursor-pointer">
                                    <input type="checkbox" name="size" value="ETI" class="w-4 h-4 text-indigo-600 rounded" checked>
                                    <span>ETI (250-4999 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-xs cursor-pointer">
                                    <input type="checkbox" name="size" value="GE" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>GE (+5000 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-xs cursor-pointer border-t pt-2">
                                    <input type="checkbox" id="includeUnknown" class="w-4 h-4 text-slate-400 rounded">
                                    <span class="text-slate-500 italic">Inclure tailles inconnues (NN)</span>
                                </label>
                            </div>
                        </div>

                        <button id="processBtn" disabled class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white font-bold py-3 rounded-lg shadow-lg transition-all text-sm">
                            Filtrer & Rechercher Contacts
                        </button>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-2">
                <div id="resultsContainer" class="glass p-6 rounded-2xl shadow-sm min-h-[500px]">
                    <div id="welcomeState" class="text-center py-20">
                        <div class="bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 italic font-serif text-2xl text-indigo-500 font-bold">CSV</div>
                        <h3 class="text-lg font-medium text-slate-800">Prêt pour l'analyse</h3>
                        <p class="text-slate-500 max-w-xs mx-auto text-sm">Chargement intelligent des colonnes denominationUniteLegale et codePostalEtablissement.</p>
                    </div>

                    <div id="loadingState" class="hidden py-10 text-center space-y-4">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                        <p id="loadingMsg" class="text-indigo-600 font-medium italic text-sm">Recherche des coordonnées...</p>
                        <div class="max-w-xs mx-auto bg-slate-100 h-2 rounded-full overflow-hidden">
                            <div id="progressBar" class="bg-indigo-500 h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>

                    <div id="resultsContent" class="hidden space-y-6">
                        <div class="flex justify-between items-center border-b pb-4">
                            <h2 class="text-xl font-bold text-slate-800"><span id="matchCount">0</span> Entreprises identifiées</h2>
                            <button id="exportBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-4 py-2 rounded-lg font-bold">Exporter l'enrichissement</button>
                        </div>
                        <div id="resultsList" class="space-y-4"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const processBtn = document.getElementById('processBtn');
        const resultsList = document.getElementById('resultsList');
        const progressBar = document.getElementById('progressBar');
        const loadingMsg = document.getElementById('loadingMsg');
        
        let allCsvData = [];
        let enrichedData = [];

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('active'); };
        dropZone.ondragleave = () => dropZone.classList.remove('active');
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('active'); handleFile(e.dataTransfer.files[0]); };
        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
                if (lines.length < 1) return;

                const separator = lines[0].includes(';') ? ';' : ',';
                const headers = lines[0].split(separator).map(h => h.replace(/["]/g, '').trim());
                
                // MAPPING SIRENE - Très précis selon votre fichier
                const idxNom = headers.findIndex(h => h === 'denominationUniteLegale' || h === 'nomUniteLegale');
                const idxSiren = headers.findIndex(h => h === 'siren');
                const idxCp = headers.findIndex(h => h === 'codePostalEtablissement');
                const idxTranche = headers.findIndex(h => h === 'trancheEffectifsUniteLegale' || h === 'trancheEffectifsEtablissement');
                const idxCommune = headers.findIndex(h => h === 'libelleCommuneEtablissement');

                allCsvData = lines.slice(1).map(line => {
                    const cols = line.split(separator).map(c => c.replace(/["]/g, '').trim());
                    return {
                        nom: cols[idxNom] || "Inconnu",
                        siren: cols[idxSiren] || "",
                        cp: cols[idxCp] || "",
                        commune: cols[idxCommune] || "",
                        tranche: cols[idxTranche] || "NN"
                    };
                }).filter(item => item.nom !== "Inconnu" && item.nom !== "");

                document.getElementById('fileStatus').classList.remove('hidden');
                document.getElementById('fileCount').innerText = allCsvData.length;
                processBtn.disabled = false;
            };
            reader.readAsText(file);
        }

        async function enrichWithIA(batch) {
            const listStr = batch.map(e => `${e.nom} à ${e.commune} (${e.cp})`).join(' | ');
            const systemPrompt = "Tu es un agent expert en OSINT B2B. Trouve le téléphone (format français) et l'email de contact officiel ou du siège.";
            const userQuery = `Recherche coordonnées : ${listStr}. Réponds strictement en JSON : { "results": [{ "nom": "Nom exact du CSV", "tel": "...", "email": "...", "site": "..." }] }`;

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        tools: [{ "google_search": {} }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await resp.json();
                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(content || '{}').results || [];
            } catch (e) { return []; }
        }

        processBtn.onclick = async () => {
            const dept = document.getElementById('deptFilter').value.trim();
            const selectedSizes = Array.from(document.querySelectorAll('input[name="size"]:checked')).map(cb => cb.value);
            const includeUnknown = document.getElementById('includeUnknown').checked;

            const filteredData = allCsvData.filter(ent => {
                // Filtre département avec sécurité (si le CP est '54000', startsWith('54') marche)
                const sCp = String(ent.cp).padStart(5, '0');
                const matchDept = dept ? sCp.startsWith(dept) : true;
                
                const t = ent.tranche;
                let matchSize = false;
                
                if (t === "NN" || t === "" || t === "null") {
                    matchSize = includeUnknown;
                } else {
                    const nT = parseInt(t);
                    // PME : 11 (10-19) à 22 (200-249)
                    if (selectedSizes.includes('PME') && nT >= 11 && nT <= 22) matchSize = true;
                    // ETI : 31 (250-499) à 42 (2000-4999)
                    if (selectedSizes.includes('ETI') && nT >= 31 && nT <= 42) matchSize = true;
                    // GE : 51+
                    if (selectedSizes.includes('GE') && nT >= 51) matchSize = true;
                }

                if (selectedSizes.length === 0 && !includeUnknown) matchSize = true;

                return matchDept && matchSize;
            });

            if (filteredData.length === 0) {
                alert("Aucune entreprise trouvée. Essayez de cocher 'Inclure tailles inconnues' car beaucoup de grandes entreprises n'ont pas leur effectif renseigné au niveau de l'établissement.");
                return;
            }

            document.getElementById('welcomeState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultsContent').classList.add('hidden');
            resultsList.innerHTML = '';
            enrichedData = [];

            const batchSize = 2;
            for (let i = 0; i < filteredData.length; i += batchSize) {
                const batch = filteredData.slice(i, i + batchSize);
                progressBar.style.width = `${Math.round((i / filteredData.length) * 100)}%`;
                loadingMsg.innerText = `OSINT : ${i} / ${filteredData.length} entreprises...`;

                const results = await enrichWithIA(batch);
                
                batch.forEach(ent => {
                    const extra = results.find(r => ent.nom.toLowerCase().includes(r.nom.toLowerCase()) || r.nom.toLowerCase().includes(ent.nom.toLowerCase())) || {};
                    const merged = { ...ent, ...extra };
                    enrichedData.push(merged);
                    
                    const card = document.createElement('div');
                    card.className = "p-4 border border-slate-200 rounded-xl bg-white shadow-sm flex justify-between items-center transition-all hover:border-indigo-300";
                    card.innerHTML = `
                        <div>
                            <h4 class="font-bold text-indigo-900 text-sm uppercase">${merged.nom}</h4>
                            <p class="text-[10px] text-slate-500">${merged.cp} ${merged.commune} | SIREN: ${merged.siren} | Tranche: ${merged.tranche}</p>
                            <div class="flex gap-4 mt-2 text-[11px]">
                                <span class="text-indigo-600 font-bold">Tel: ${merged.tel || 'Recherche...'}</span>
                                <span class="text-indigo-600 font-bold">Email: ${merged.email || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                    resultsList.appendChild(card);
                });
            }

            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultsContent').classList.remove('hidden');
            document.getElementById('matchCount').innerText = enrichedData.length;
        };

        document.getElementById('exportBtn').onclick = () => {
            const csvRows = ["Nom;Siren;CP;Commune;Tranche;Telephone;Email;Site"];
            enrichedData.forEach(e => {
                csvRows.push(`"${e.nom}";"${e.siren}";"${e.cp}";"${e.commune}";"${e.tranche}";"${e.tel || ''}";"${e.email || ''}";"${e.site || ''}"`);
            });
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "prospection_enrichie.csv";
            link.click();
        };
    </script>
</body>
</html>
