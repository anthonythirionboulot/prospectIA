<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent IA de prospection - API Gouv & OSINT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 1);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2 italic">Prospecteur B2B Pro</h1>
            <p class="text-slate-500 font-medium">Extraction SIRENE (Gouv.fr) & Enrichissement Intelligence Artificielle</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <aside class="lg:col-span-1 space-y-6">
                <div class="glass p-6 rounded-2xl shadow-sm border-t-4 border-t-indigo-500">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Critères de Recherche
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Code NAF</label>
                                <input type="text" id="nafInput" placeholder="ex: 4211Z" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Dépt.</label>
                                <input type="text" id="deptInput" placeholder="ex: 54" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Segment Entreprise</label>
                            <div class="space-y-2 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="PME" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>PME (10-249 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="ETI" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>ETI (250-4999 sal.)</span>
                                </label>
                                <label class="flex items-center space-x-3 text-sm cursor-pointer">
                                    <input type="checkbox" name="size" value="GE" class="w-4 h-4 text-indigo-600 rounded">
                                    <span>Grandes Entreprises (+5000)</span>
                                </label>
                            </div>
                        </div>

                        <button id="searchBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all flex items-center justify-center space-x-2 mt-4">
                            <span id="btnText">Lancer la recherche</span>
                        </button>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-2">
                <div id="resultsContainer" class="glass p-6 rounded-2xl shadow-sm min-h-[500px]">
                    <div id="welcomeState" class="text-center py-20">
                        <div class="bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                        <h3 class="text-lg font-medium text-slate-800">Prêt pour l'extraction</h3>
                        <p class="text-slate-500 max-w-xs mx-auto text-sm">Entrez un code NAF et un département pour interroger la base nationale.</p>
                    </div>

                    <div id="loadingState" class="hidden space-y-4 py-10">
                        <div class="flex flex-col items-center">
                            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                            <p id="loadingMessage" class="text-indigo-600 font-medium italic text-sm">Appel des services de l'État...</p>
                        </div>
                    </div>

                    <div id="resultsContent" class="hidden space-y-6">
                        <div class="flex justify-between items-center border-b pb-4">
                            <h2 class="text-xl font-bold text-slate-800">Entreprises Identifiées</h2>
                            <button onclick="copyTable()" class="text-indigo-600 text-xs font-bold hover:underline">Exporter CSV</button>
                        </div>
                        <div id="resultsList" class="space-y-4"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_KEY_GEMINI = ""; 
        const searchBtn = document.getElementById('searchBtn');
        const nafInput = document.getElementById('nafInput');
        const deptInput = document.getElementById('deptInput');
        const loadingState = document.getElementById('loadingState');
        const loadingMessage = document.getElementById('loadingMessage');
        const resultsContent = document.getElementById('resultsContent');
        const resultsList = document.getElementById('resultsList');
        const welcomeState = document.getElementById('welcomeState');

        function getTranchesEffectifs(sizes) {
            let tranches = [];
            if (sizes.includes('PME')) tranches.push("11,12,21,22");
            if (sizes.includes('ETI')) tranches.push("31,32,41");
            if (sizes.includes('GE')) tranches.push("51,52,53");
            return tranches.join(',');
        }

        async function fetchOfficialData(naf, dept, sizes) {
            const cleanNaf = naf.trim().replace(/[\.\s]/g, '').toUpperCase();
            const tranches = getTranchesEffectifs(sizes);
            
            // Stratégie : Utiliser l'activité principale de l'unité légale (plus stable)
            let url = `https://recherche-entreprises.api.gouv.fr/search?activite_principale=${cleanNaf}&departement=${dept}`;
            
            if (tranches) {
                url += `&tranche_effectif_salarie=${tranches}`;
            }
            
            url += `&per_page=15`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    // Si l'API renvoie une erreur, on tente une recherche par mots clés (Plan B)
                    const fallbackUrl = `https://recherche-entreprises.api.gouv.fr/search?q=${cleanNaf}&departement=${dept}&per_page=15`;
                    const fallbackResponse = await fetch(fallbackUrl);
                    if (!fallbackResponse.ok) throw new Error("Service API temporairement indisponible.");
                    const fallbackData = await fallbackResponse.json();
                    return fallbackData.results || [];
                }
                const data = await response.json();
                return data.results || [];
            } catch (e) {
                throw e;
            }
        }

        async function enrichWithGemini(entreprises) {
            if (entreprises.length === 0) return [];

            const listStr = entreprises.map(e => `${e.nom_complet} (${e.siege.adresse})`).join(' | ');
            
            const prompt = `Trouve les coordonnées B2B pour ces entreprises françaises : ${listStr}. 
            Format JSON requis: { "enrichissements": [{ "nom": "Nom exact", "tel": "numéro", "email": "email", "site": "url" }] }`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY_GEMINI}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) return [];
                const resJson = await response.json();
                return JSON.parse(resJson.candidates[0].content.parts[0].text).enrichissements || [];
            } catch (err) {
                return [];
            }
        }

        searchBtn.addEventListener('click', async () => {
            const naf = nafInput.value.trim();
            const dept = deptInput.value.trim();
            const selectedSizes = Array.from(document.querySelectorAll('input[name="size"]:checked')).map(cb => cb.value);

            if (!naf || !dept) {
                alert("Veuillez remplir le code NAF et le département.");
                return;
            }

            welcomeState.classList.add('hidden');
            resultsContent.classList.add('hidden');
            loadingState.classList.remove('hidden');
            loadingMessage.innerText = "Interrogation de la base SIRENE...";
            searchBtn.disabled = true;

            try {
                const gouvResults = await fetchOfficialData(naf, dept, selectedSizes);
                
                if (gouvResults.length === 0) {
                    resultsList.innerHTML = '<p class="text-center py-10 text-slate-500">Aucun résultat officiel trouvé. Vérifiez vos critères.</p>';
                } else {
                    loadingMessage.innerText = "Enrichissement des données par l'IA...";
                    const enriched = await enrichWithGemini(gouvResults);

                    resultsList.innerHTML = '';
                    gouvResults.forEach(ent => {
                        const extra = enriched.find(e => ent.nom_complet.toLowerCase().includes(e.nom.toLowerCase()) || e.nom.toLowerCase().includes(ent.nom_complet.toLowerCase())) || {};
                        const card = document.createElement('div');
                        card.className = "p-5 border border-slate-200 rounded-xl bg-white shadow-sm hover:border-indigo-300 transition-all";
                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-indigo-900 uppercase text-sm">${ent.nom_complet}</h4>
                                <span class="text-[9px] bg-slate-100 text-slate-600 px-2 py-1 rounded">SIREN ${ent.siren}</span>
                            </div>
                            <p class="text-xs text-slate-500 mb-3">${ent.siege.adresse}</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-[11px] border-t pt-3">
                                <span><strong>TEL:</strong> ${extra.tel || 'Non trouvé'}</span>
                                <span class="text-indigo-600"><strong>EMAIL:</strong> ${extra.email || 'N/A'}</span>
                                ${extra.site ? `<a href="${extra.site}" target="_blank" class="text-indigo-400 underline truncate">${extra.site}</a>` : '<span>Site Web N/A</span>'}
                            </div>
                        `;
                        resultsList.appendChild(card);
                    });
                }
                resultsContent.classList.remove('hidden');
            } catch (err) {
                alert("Erreur : " + err.message);
                welcomeState.classList.remove('hidden');
            } finally {
                loadingState.classList.add('hidden');
                searchBtn.disabled = false;
            }
        });

        function copyTable() {
            const data = Array.from(document.querySelectorAll('#resultsList > div')).map(card => {
                const nom = card.querySelector('h4').innerText.trim();
                const addr = card.querySelector('p').innerText.trim();
                return `${nom}\t${addr}`;
            }).join('\n');
            const blob = new Blob(["Nom\tAdresse\n" + data], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'entreprises.csv';
            a.click();
        }
    </script>
</body>
</html>
